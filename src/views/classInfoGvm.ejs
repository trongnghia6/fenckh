<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Học Viện Kỹ Thuật Mật Mã</title>
    <link rel="stylesheet" href="/css/table.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="/css/styles.css" />
    <link rel="stylesheet" href="/css/gvmList.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    />

    <style>
      /* nmsvbmbvsmnvds */
      .teacher-group {
        border: 2px solid black;
        /* Viền đen xung quanh nhóm giảng viên */
        border-collapse: separate;
        margin-bottom: 10px;
      }

      .teacher-group td,
      .teacher-group th {
        padding: 8px;
        text-align: left;
        border: 2px solid black;
        /* Viền đen xung quanh nhóm giảng viên */
      }
    </style>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
  }
  
  .class-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
    table-layout: auto; /* Cho phép bảng tự điều chỉnh kích thước cột */
  }
  
  .class-table th, .class-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
    white-space: normal; /* Cho phép xuống dòng */
    word-wrap: break-word; /* Chia từ và xuống dòng khi cần */
  }
  
  .class-table th {
    background-color: #007BFF; /* Đổi màu nền tiêu đề thành xanh dương */
    color: white;
    font-weight: bold;
  }
  
  .class-table tbody tr:nth-child(even) {
    background-color: #f2f2f2;
  }
  
  .class-table tbody tr:hover {
    background-color: #ddd;
  }
  
  .action-button {
    background-color: #4CAF50;
    color: white;
    padding: 5px 10px;
    border: none;
    cursor: pointer;
    border-radius: 5px;
  }
  
  .action-button:hover {
    background-color: #45a049;
  }
  
  /* Điều chỉnh kích thước các cột */
  .class-table th, .class-table td {
    min-width: 50px; /* Đặt kích thước tối thiểu cho cột để không bị quá hẹp */
  }
  
</style>
    <!-- Phân quyền -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        //const role = localStorage.getItem("userRole");
        const MaPhongBan = localStorage.getItem("MaPhongBan");
        // Ẩn phần lọc khoa nếu role là Khoa
        const departmentFilter = document.getElementById("departmentFilter");

        if (
          !MaPhongBan.includes("DAOTAO") &&
          !MaPhongBan.includes("TAICHINH")
        ) {
          departmentFilter.style.display = "none";
        }
      });
    </script>
  </head>

  <body>
    <nav class="navbar-top">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <img src="/Logo-Hoc-Vien-Ky-Thuat-Mat-Ma-ACTVN.webp" alt="Logo" />
          <div class="navbar-title">
            <img src="/dongchu_banner.png" alt="banner" />
          </div>
        </a>
      </div>
    </nav>

    <!-- Phần dưới của navbar chứa các mục nằm ngang -->
    <nav class="navbar navbar-expand-lg navbar-bottom sticky-top">
      <div class="" style="width: 100%">
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div
          class="collapse navbar-collapse"
          style="width: 100%"
          id="navbarNav"
        >
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" id="Home" href=""
                ><i class="fa-solid fa-house"></i
              ></a>
            </li>
            <div class="navbar-nav">
              <div class="nav-item dropdown">
                <a
                  class="nav-link dropdown-toggle"
                  href="/login"
                  id="navbarDropdownUser"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  Giảng Viên Mời
                </a>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                  <a class="nav-link" href="/gvmList"
                    >Danh sách giảng viên mời</a
                  >
                  <a class="nav-link" id="Import" href="">Thêm bằng file</a>
                </div>
              </div>
            </div>
            <div class="navbar-nav">
              <div class="nav-item dropdown">
                <a
                  class="nav-link dropdown-toggle"
                  href="/login"
                  id="navbarDropdownUser"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  Bảng Quy Chuẩn
                </a>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                  <a class="nav-link" href="/tableTam"
                    >Bảng quy chuẩn dự kiến</a
                  >
                  <a class="nav-link" href="/tableQC"
                    >Bảng quy chuẩn chính thức</a
                  >
                  <a class="nav-link" id="ThongTinGD" href=""
                    >Thông tin giảng viên theo lớp</a
                  >
                </div>
              </div>
            </div>
            <div class="navbar-nav">
              <div class="nav-item dropdown">
                <a
                  class="nav-link dropdown-toggle active"
                  href="/login"
                  id="navbarDropdownUser"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  Mời Giảng
                </a>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                  <a class="nav-link" href="/xemCacLopGvm">Xem các lớp mời</a>

                  <a class="nav-link active" href="/classInfoGvm"
                    >Thông tin lớp giảng viên mời</a
                  >
                  <a class="nav-link" href="/infoHDGvm" role="button"
                    >Thông tin hợp đồng</a
                  >
                </div>
              </div>
            </div>
            <div class="navbar-nav">
              <div class="nav-item dropdown">
                <a
                  class="nav-link dropdown-toggle"
                  href="/login"
                  id="navbarDropdownUser"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  Vượt Giờ
                </a>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                  <a class="nav-link" id="ThongTinGD" href="#">COMING SOON</a>
                </div>
              </div>
            </div>
            <div class="navbar-nav">
              <div class="nav-item dropdown">
                <a
                  class="nav-link dropdown-toggle"
                  href="/login"
                  id="navbarDropdownUser"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  Nghiên Cứu Khoa Học
                </a>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                  <a class="nav-link" id="ThongTinGD" href="#">COMING SOON</a>
                </div>
              </div>
            </div>
            <div class="navbar-nav">
              <div class="nav-item dropdown">
                <a
                  class="nav-link dropdown-toggle"
                  href="/login"
                  id="navbarDropdownUser"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  Đồ Án
                </a>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                  <a class="nav-link" id="ThongTinGD" href="#">COMING SOON</a>
                </div>
              </div>
            </div>
            <div class="navbar-nav">
              <div class="nav-item dropdown">
                <a
                  class="nav-link dropdown-toggle"
                  href="/login"
                  id="navbarDropdownUser"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  Thống Kê
                </a>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                  <a class="nav-link" id="ThongTinGD" href="#">COMING SOON</a>
                </div>
              </div>
            </div>
          </ul>
          <div class="navbar-nav">
            <div class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle fullname"
                href="/login"
                id="navbarDropdownUser"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                Hi, Lê Đức Thuận
              </a>
              <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <a class="dropdown-item" href="#">Thông tin cá nhân</a>
                <a class="dropdown-item" href="/">Đăng xuất</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>
    <div class="container-fluid m-4 box">
      <div class="d-flex justify-content-center">
        <!-- Main content -->
        <div class="gvmList" style="width: 100%">
          <div class="m-3">
            <div class="">
              <h1>THÔNG TIN CÁC LỚP GIẢNG VIÊN MỜI</h1>
              <div class="header-actions"  style="height: 45px;">

                <!-- <button class="add-class" onclick="addClass()">+ Thêm giảng viên mời</button> -->
                <input
                  type="text"
                  placeholder="Tìm kiếm theo Tên..."
                  class="search"
                  id="searchInput"
                  onkeyup="searchClass()"
                />
                
              <div class="loc" style="margin-top: -15px;">
                <select class="selectop" id="combobox-dot">
                  <option value="1">Đợt 1</option>
                  <option value="2">Đợt 2</option>
                </select>
        
                <!-- Combo box kì -->
                <select class="selectop" id="combobox-ki">
                  <option value="1">Kỳ 1</option>
                  <option value="2">Kỳ 2</option>
                </select>
        
                <!-- Combo box Năm -->
                <select class="selectop" id="combobox-nam">
                  <option value="2024">2024</option>
                  <option value="2025">2025</option>
                  <option value="2026">2026</option>
                  <option value="2027">2027</option>
                </select>
                <select class="selectop" id="departmentFilter">
                  <option value="">Tất cả khoa</option>
                  <option value="CNTT">Công nghệ thông tin</option>
                  <option value="ATTT">An toàn thông tin</option>
                  <option value="DTVT">Điện tử viễn thông</option>
                  <option value="MM">Mật mã</option>
                </select>
                
                <script>
    
                  function filterTable() {
                      // Lấy giá trị đã chọn
                      let dot = document.getElementById("combobox-dot").value;
                      let ki = document.getElementById("combobox-ki").value;
                      let nam = document.getElementById("combobox-nam").value;
                      let department = document.getElementById("departmentFilter").value.trim();
                
                      let tbody = document.getElementById("data-table-body");
                      let rows = tbody.getElementsByTagName("tr");
                
                      for (let i = 0; i < rows.length; i++) {
                          let row = rows[i];
                          let cells = row.getElementsByTagName("td");
                          
                          // Giả sử thứ tự cột là: Khoa, Đợt, Kì, Năm
                          let rowDepartment = cells[0].textContent.trim();
                          let rowDot = cells[1].textContent.trim();
                          let rowKi = cells[2].textContent.trim();
                          let rowNam = cells[3].textContent.trim();
                
                          // Logic lọc
                          let matchesDepartment = department === "" || rowDepartment === department;
                          let matchesDot = dot === "" || rowDot === dot;
                          let matchesKi = ki === "" || rowKi === ki;
                          let matchesNam = nam === "" || rowNam === nam;
                
                          // Hiển thị hoặc ẩn hàng dựa trên kết quả lọc
                          if (matchesDepartment && matchesDot && matchesKi && matchesNam) {
                              row.style.display = ""; // Hiển thị hàng
                          } else {
                              row.style.display = "none"; // Ẩn hàng
                          }
                      }
                  }
                    </script>
                <button class="button text-nowrap" id="render" 
                  style="margin-top: 17px;" 
                  onclick="filterTable()">Hiển thị
                </button>
                </div>
              </div>

              <table class="class-table" id="classTable">
                <thead>
                  <tr>
                    <th>STT</th>
                    <th>Giảng viên</th>
                    <th>Môn học</th>
                    <th>Tên lớp</th>
                    <th>Số tín chỉ</th>
                    <th>Ngày bắt đầu</th>
                    <th>Ngày kết thúc</th>
                    <th>Số tiết</th>
                    <th>Tổng số tiết</th>
                    <th>Mã học phần</th>
                    <!-- Cột Khoa -->
                    <th>Chi tiết giảng viên mời</th>
                  </tr>
                </thead>
                <tbody class="teacher-group">
                  <% let index = 1; %> 
                  <% for (let teacher of Object.keys(GiangDay)) { %> 
                    <% let courses = GiangDay[teacher]; %> 
                    <% let totalSoTiet = courses.reduce((total, course) => total + course.QuyChuan, 0); %>
                    <tr class="teacher-group" data-department="<%= courses[0].Khoa %>">
                      <% courses.forEach((course, courseIndex) => { %>
                        <tr data-department="<%= course.Khoa %>">
                          <% if (courseIndex === 0) { %>
                            <td rowspan="<%= courses.length %>"><%= index %></td>
                            <td rowspan="<%= courses.length %>"><%= course.GiaoVienGiangDay %></td>
                            <% index++; %> 
                          <% } %>
                          <td><%= course.LopHocPhan %></td>
                          <td><%= course.TenLop %></td>
                          <td><%= course.SoTinChi %></td>
                          
                          <% function formatDate(dateStr) { %>
                            <% if (!dateStr) return 'N/A'; %>
                            <% const date = new Date(dateStr); %>
                            <% if (isNaN(date.getTime())) return 'N/A'; %>
                            <% const day = String(date.getDate()).padStart(2, '0'); %>
                            <% const month = String(date.getMonth() + 1).padStart(2, '0'); %>
                            <% const year = date.getFullYear(); %>
                            <% return `${day}/${month}/${year}`; %>
                          <% } %>
                          
                          <td><%= formatDate(course.NgayBatDau) %></td>
                          <td><%= formatDate(course.NgayKetThuc) %></td>
                          <td><%= course.QuyChuan %></td>
                          
                          <% if (courseIndex === 0) { %>
                            <td rowspan="<%= courses.length %>"><%= totalSoTiet %></td>
                            <td rowspan="<%= courses.length %>"><%= course.Khoa %></td>
                            <td rowspan="<%= courses.length %>">
                              <button class="action-button view" onclick="viewClass('<%= parseInt(course.id_Gvm) - 1 %>')">👁️</button>
                            </td>
                          <% } %>
                        </tr>
                      <% }); %>
                    </tr>
                  <% } %>
                </tbody>
                
              </table>
              <!-- <div class="pagination">
                              <span>10 / trang</span>
                              <button class="page-button">1</button>
                            </div> -->
            </div>

            <div id="modal" class="modal" style="display: none">
              <div class="modal-content">
                <span class="close-button" onclick="closeModal()">×</span>
                <h2 id="modal-title">Chi tiết giảng viên mời</h2>
                <br />
                <p>
                  <strong>Mã giảng viên:</strong> <span id="modal-ma-gv"></span>
                </p>
                <p><strong>Họ tên:</strong> <span id="modal-ho-ten"></span></p>
                <p>
                  <strong>Ngày sinh:</strong> <span id="modal-ngay-sinh"></span>
                </p>
                <p><strong>CCCD:</strong> <span id="modal-cccd"></span></p>
                <p>
                  <strong>Ngày cấp CCCD:</strong>
                  <span id="modal-ngay-cap"></span>
                </p>
                <p>
                  <strong>Nơi cấp CCCD:</strong>
                  <span id="modal-noi-cap"></span>
                </p>
                <p>
                  <strong>Địa chỉ theo CCCD:</strong>
                  <span id="modal-dia-chi-cccd"></span>
                </p>
                <p>
                  <strong>Số tài khoản:</strong> <span id="modal-so-tk"></span>
                </p>
                <p>
                  <strong>Ngân hàng:</strong> <span id="modal-ngan-hang"></span>
                </p>
                <p><strong>Email:</strong> <span id="modal-email"></span></p>
                <p>
                  <strong>Hệ số lương:</strong>
                  <span id="modal-heso-luong"></span>
                </p>
                <p>
                  <strong>Nơi công tác:</strong>
                  <span id="modal-noi-cong-tac"></span>
                </p>
                <p>
                  <strong>Chức vụ:</strong> <span id="modal-chuc-vu"></span>
                </p>
                <p>
                  <strong>Mã số thuế:</strong>
                  <span id="modal-ma-so-thue"></span>
                </p>
                <p>
                  <strong>Tốt nghiệp loại:</strong>
                  <span id="modal-tot-nghiep-loai"></span>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="/bootstrap/dist/js/jquery-3.7.1.min.js"></script>
    <script src="/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

    <!-- <script>
        function filterGvmByDepartment() {
          var filter = document.getElementById("departmentFilter").value;
          var table = document.getElementById("classTable");
          var tbody = document.getElementById("teacher-group");
          var rows = tbody.getElementsByTagName("tr");

          for (var i = 0; i < rows.length; i++) {
            var row = rows[i];
            var department = row.getAttribute("data-department");

            if (filter === "" || department === filter) {
              row.style.display = "";
            } else {
              row.style.display = "none";
            }
          }
        }
      </script> -->

    <script>
      // Tìm kiếm giảng viên mời theo tên
      function searchClass() {
        let input = document.getElementById("searchInput").value.toLowerCase();
        let table = document.getElementById("classTable");
        let rows = table.getElementsByTagName("tr");

        let currentGroup = null;
        let groupVisible = false;

        for (let i = 1; i < rows.length; i++) {
          // Bắt đầu từ 1 để bỏ qua hàng tiêu đề
          let row = rows[i];

          if (row.classList.contains("teacher-group")) {
            // Đây là hàng đầu tiên của một nhóm giảng viên mới
            if (currentGroup) {
              // Ẩn/hiện nhóm trước đó dựa trên kết quả tìm kiếm
              setGroupVisibility(currentGroup, groupVisible);
            }

            currentGroup = [];
            groupVisible = false;
          }

          currentGroup.push(row);

          let teacherNameCell = row.cells[1]; // Giả sử tên giảng viên ở cột thứ 2
          if (teacherNameCell) {
            let teacherName = teacherNameCell.textContent.toLowerCase();
            if (teacherName.includes(input)) {
              groupVisible = true;
            }
          }
        }

        // Xử lý nhóm cuối cùng
        if (currentGroup) {
          setGroupVisibility(currentGroup, groupVisible);
        }
      }

      function setGroupVisibility(group, isVisible) {
        for (let row of group) {
          row.style.display = isVisible ? "" : "none";
        }
      }

      async function fetchGVMLists() {
        try {
          const response = await fetch("/api/classInfoGvm");
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          const gvmLists = await response.json();
          return gvmLists;
        } catch (error) {
          console.error("Error fetching data:", error);
        }
      }

      async function viewClass(index) {
        gvmLists = await fetchGVMLists();

        index = parseInt(index);

        var gvm = gvmLists[index];

        // Hiển thị thông tin vào modal
        document.getElementById("modal-ma-gv").innerText = gvm.MaGvm;
        document.getElementById("modal-ho-ten").innerText = gvm.HoTen;
        document.getElementById("modal-ngay-sinh").innerText = new Date(
          gvm.NgaySinh
        ).toLocaleDateString("vi-VN");
        document.getElementById("modal-cccd").innerText = gvm.CCCD;
        document.getElementById("modal-ngay-cap").innerText = new Date(
          gvm.NgayCapCCCD
        ).toLocaleDateString("vi-VN");
        document.getElementById("modal-noi-cap").innerText = gvm.NoiCapCCCD;
        document.getElementById("modal-dia-chi-cccd").innerText = gvm.DiaChi;
        document.getElementById("modal-so-tk").innerText = gvm.STK;
        document.getElementById("modal-ngan-hang").innerText = gvm.NganHang;
        document.getElementById("modal-email").innerText = gvm.Email;
        document.getElementById("modal-heso-luong").innerText = gvm.HSL; //
        document.getElementById("modal-noi-cong-tac").innerText =
          gvm.NoiCongTac;
        document.getElementById("modal-chuc-vu").innerText = gvm.ChucVu;
        document.getElementById("modal-ma-so-thue").innerText = gvm.MaSoThue;
        document.getElementById("modal-tot-nghiep-loai").innerText =
          gvm.TotNghiepLoai;

        // Hiển thị modal
        document.getElementById("modal").style.display = "flex";
      }

      // Đóng modal
      function closeModal() {
        document.getElementById("modal").style.display = "none";
      }

      // Thêm sự kiện khi nhấn ra ngoài modal để đóng modal
      window.onclick = function (event) {
        let modal = document.getElementById("modal");
        if (event.target == modal) {
          modal.style.display = "none";
        }
      };
    </script>

    <script>
      // Lấy query string từ URL
      const urlParams = new URLSearchParams(window.location.search);
      const message = urlParams.get("message");

      // Lấy phần tử div để hiển thị thông báo
      const messageDiv = document.getElementById("message");

      // console.log(message)
      // Hiển thị thông báo dựa trên giá trị của message
      if (message === "insertSuccess") {
        alert("Update Success");
      } else if (message === "insertFalse") {
        alert("Update False");
      }

      // Sau khi hiển thị thông báo, xóa query string để tránh hiển thị lại khi refresh
      if (message) {
        // Sử dụng window.history để xóa query string mà không refresh lại trang
        const newUrl = window.location.origin + window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
      }
    </script>

    <!-- Phần phân quyền -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Thêm sự kiện click cho phần tử có id "import"
        const importLink = document.getElementById("Import");

        importLink.addEventListener("click", function (event) {
          event.preventDefault(); // Ngăn chặn hành vi mặc định của liên kết

          const isKhoa = localStorage.getItem("isKhoa"); // Lấy role từ localStorage

          if (isKhoa == 0) {
            // Nếu là đào tạo hoặc tài chính
            window.location.href = "/import";
          } else {
            // Nếu là khoa
            window.location.href = "/importGvmList";
          }
        });

        // Thêm sự kiện click cho phần tử có id="ThongTinGD"
        const ThongTinGD = document.getElementById("ThongTinGD");

        ThongTinGD.addEventListener("click", function (event) {
          event.preventDefault(); // Ngăn chặn hành vi mặc định của liên kết
          const isKhoa = localStorage.getItem("isKhoa"); // Lấy role từ localStorage

          if (isKhoa == 0) {
            // Nếu là đào tạo hoặc tài chính
            window.location.href = "/info2";
          } else {
            window.location.href = "/info";
          }
        });

        // Thêm sự kiện click cho phần tử có id="Home"

        const Home = document.getElementById("Home");

        Home.addEventListener("click", function (event) {
          event.preventDefault(); // Ngăn chặn hành vi mặc định của liên kết

          const isKhoa = localStorage.getItem("isKhoa");

          if (isKhoa == 0) {
            // Nếu là đào tạo hoặc tài chính
            window.location.href = "/maindt";
          } else {
            window.location.href = "/mainkhoa";
          }
        });
      });
    </script>

    <script>
      window.onload = function () {
        const TenNhanVien = localStorage.getItem("TenNhanVien"); // Lấy tên người dùng từ localStorage
        const Role = localStorage.getItem("userRole");

        if (TenNhanVien) {
          // Hiển thị tên người dùng trên phần tử HTML
          document.querySelector(
            ".fullname"
          ).innerText = `${TenNhanVien} - ${Role}`;
        } else {
          document.querySelector(".fullname").innerText = "Hi, Guest"; // Hiển thị nếu không có tên người dùng
        }

        document.querySelector(".role").innerText = `${Role}`;
      };

      
    </script>
  </body>
</html>
