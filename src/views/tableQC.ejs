<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Học Viện Kỹ Thuật Mật Mã</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <style>
    /* CSS cho bảng */
    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .table th,
    .table td {
      padding: 10px;
      text-align: left;
      border: 1px solid #dee2e6;
    }

    .table th {
      background-color: #007bff;
      color: white;
      font-weight: bold;
    }

    .table tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    .table tbody tr:hover {
      background-color: #e2e6ea;
    }

    .table td {
      vertical-align: middle;
    }

    .bg-custom {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .spinner-border {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
    }



    /* Đảm bảo menu con không hiển thị mặc định */
    .dropdown-submenu .dropdown-menu {
      display: none;
      position: absolute;
      left: 100%;
      top: 0;
    }

    /* Hiển thị menu con khi hover */
    .dropdown-submenu:hover .dropdown-menu {
      display: block;
    }
  </style>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>

  <nav class="navbar-top ">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <img src="/Logo-Hoc-Vien-Ky-Thuat-Mat-Ma-ACTVN.webp" alt="Logo">
        <div class="navbar-title">
          <img src="/dongchu_banner.png" alt="banner">
        </div>
      </a>
    </div>
  </nav>

  <!-- Phần dưới của navbar chứa các mục nằm ngang -->

  <nav class="navbar navbar-expand-lg navbar-bottom sticky-top">
    <div class="" style="width: 100%;">
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" id="Home" href=""><i class="fa-solid fa-house"></i></a>
          </li>
          <!-- <div class="navbar-nav">
            <div class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="/login" id="navbarDropdownUser" data-bs-toggle="dropdown"
                aria-expanded="false">
                Giảng Viên
              </a>
              <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <a class="nav-link" id="ThongTinGD" href="">Thông tin giảng dạy</a>
                <a class="nav-link" id="Import" href="">Thêm bảng quy chuẩn</a>
                <a class="nav-link" href="/gvmList">Danh sách giảng viên mời</a>
                <a class="nav-link" id="Import" href="">Thêm bằng file</a>
              </div>
            </div>
          </div> -->

          <div class="navbar-nav">
            <div class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="/login" id="navbarDropdownUser" data-bs-toggle="dropdown"
                aria-expanded="false">
                Giảng Viên Mời
              </a>
              <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <a class="nav-link" href="/gvmList">Danh sách giảng viên mời</a>
                <a class="nav-link" id="Import" href="">Thêm bằng file</a>
              </div>
            </div>
          </div>
          <div class="navbar-nav">
            <div class="nav-item dropdown">
              <a class="nav-link dropdown-toggle active" href="/login" id="navbarDropdownUser" data-bs-toggle="dropdown"
                aria-expanded="false">
                Bảng Quy Chuẩn
              </a>
              <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <a class="nav-link" href="/tableTam">Bảng quy chuẩn dự kiến</a>
                <a class="nav-link active" href="/tableQC">Bảng quy chuẩn chính thức</a>
                <a class="nav-link" id="ThongTinGD" href="">Thông tin giảng viên theo lớp</a>
              </div>
            </div>
          </div>
          <div class="navbar-nav">
            <div class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="/login" id="navbarDropdownUser" data-bs-toggle="dropdown"
                aria-expanded="false">
                Mời Giảng
              </a>
              <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <a class="nav-link" href="/xemCacLopGvm">Xem các lớp mời</a>
                <a class="nav-link" href="/classInfoGvm">Thông tin lớp giảng viên mời</a>
                <a class="nav-link " href="/infoHDGvm" role="button">Thông tin hợp đồng</a>
              </div>
            </div>
          </div>
          <div class="navbar-nav">
            <div class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="/login" id="navbarDropdownUser" data-bs-toggle="dropdown"
                aria-expanded="false">
                Vượt Giờ
              </a>
              <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <a class="nav-link" href="#">COMING SOON</a>
              </div>
            </div>
          </div>
          <div class="navbar-nav">
            <div class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="/login" id="navbarDropdownUser" data-bs-toggle="dropdown"
                aria-expanded="false">
                Nghiên Cứu Khoa Học
              </a>
              <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <a class="nav-link" href="#">COMING SOON</a>
              </div>
            </div>
          </div>
          <div class="navbar-nav">
            <div class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="/login" id="navbarDropdownUser" data-bs-toggle="dropdown"
                aria-expanded="false">
                Đồ Án
              </a>
              <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <a class="nav-link" href="#">COMING SOON</a>
              </div>
            </div>
          </div>
          <div class="navbar-nav">
            <div class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="/login" id="navbarDropdownUser" data-bs-toggle="dropdown"
                aria-expanded="false">
                Thống Kê
              </a>
              <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <a class="nav-link" href="#">COMING SOON</a>
              </div>
            </div>
          </div>
        </ul>
        <div class="navbar-nav">
          <div class="nav-item dropdown">
            <a class="nav-link dropdown-toggle fullname" href="/login" id="navbarDropdownUser" data-bs-toggle="dropdown"
              aria-expanded="false">
              Hi, Lê Đức Thuận
            </a>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
              <a class="dropdown-item" href="#">Thông tin cá nhân</a>
              <a class="dropdown-item" href="/">Đăng xuất</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid box m-4  ">
    <div class="mx-5 flex-grow-1">
      <div class="d-flex justify-content-start mb-3">

        <!-- Combo box Đợt -->
        <select class="form-select w-100px mx-1 selectop" id="combobox-dot">
          <option value="1">Đợt 1</option>
          <option value="2">Đợt 2</option>
        </select>

        <!-- Combo box kì -->
        <select class="form-select w-100px mx-1 selectop" id="combobox-ki">
          <option value="1">Kì 1</option>
          <option value="2">Kì 2</option>
        </select>

        <!-- Combo box Năm -->
        <select class="form-select w-100px mx-1 selectop" id="combobox-nam">
          <option value="2024">2024</option>
          <option value="2025">2025</option>
          <option value="2026">2026</option>
          <option value="2027">2027</option>
        </select>

        <!-- Combo box với các giá trị CNTT, ATTT, DTVT -->
        <select class="form-select w-100px mx-1 selectop" id="combobox-khoa">
          <option value="CNTT">CNTT</option>
          <option value="ATTT">ATTT</option>
          <option value="DTVT">DTVT</option>
        </select>

        <button class="button text-nowrap" id="render">Hiển thị</button>
        <!-- <button class="btn btn-success mx-2" id="filter">Lọc</button> -->
        <!-- Nút Lọc màu giống nút Hiển thị -->

        <!-- <div class="btn-group">
          <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            Lọc
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" id="filter-guest-class">Các lớp mời giảng</a></li>
            <li><a class="dropdown-item" href="#" id="filter-teacher-name">Theo tên giảng viên</a></li>
            <li class="dropdown-submenu">
              <a class="dropdown-item" href="#" id="filter-by-department">Theo khoa</a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" id="filter-dept-cntt">CNTT</a></li>
                <li><a class="dropdown-item" href="#" id="filter-dept-attt">ATTT</a></li>
                <li><a class="dropdown-item" href="#" id="filter-dept-dtvt">DTVT</a></li>
                <li><a class="dropdown-item" href="#" id="filter-dept-mm">MM</a></li>
                <li><a class="dropdown-item" href="#" id="filter-dept-gdtc">GDTC</a></li>
                <li><a class="dropdown-item" href="#" id="filter-dept-cb">CB</a></li>
                <li><a class="dropdown-item" href="#" id="filter-dept-llct">LLCT</a></li>
              </ul>
            </li>
          </ul>
        </div> -->


      </div>
      <div class="overflow-auto">
        <table class="table table-bordered">
          <thead>
            <tr id="table-header"></tr>
          </thead>
          <tbody id="data-table-body"></tbody>
        </table>
      </div>
    </div>
  </div>
  </div>

  <script>

    // Lắng nghe sự kiện click vào button
    document.getElementById('render').addEventListener('click', function () {
      loadData(); // Gọi hàm loadData khi button được click
    });


    async function loadData() {
      try {
        // Biến để lưu trữ giá trị mặc định
        let dotValue = document.getElementById('combobox-dot').value;
        let kiValue = document.getElementById('combobox-ki').value;
        let namValue = document.getElementById('combobox-nam').value;
        let khoaValue = document.getElementById('combobox-khoa').value;

        // Hàm cập nhật giá trị từ comboboxes
        const updateValues = () => {
          dotValue = document.getElementById('combobox-dot').value;
          kiValue = document.getElementById('combobox-ki').value;
          namValue = document.getElementById('combobox-nam').value;
          khoaValue = document.getElementById('combobox-khoa').value;

          console.log({ dotValue, kiValue, namValue, khoaValue }); // In ra giá trị hiện tại
        };

        // Hàm xử lý sự thay đổi ở bất kỳ combobox nào
        const handleComboboxChange = async () => {
          updateValues(); // Cập nhật giá trị khi có sự thay đổi

          // Tạo đối tượng dữ liệu để gửi
          const requestData = {
            Khoa: khoaValue,
            Dot: dotValue,
            Ki: kiValue,
            Nam: namValue,
          };

          console.log(requestData);
          // Fetch thông tin giảng dạy
          const teachingResponse = await fetch('http://localhost:3000/quy-chuan-chinh-thuc', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData),
          });

          if (!teachingResponse.ok) {
            alert("Lỗi truy vấn!");
            return;
          }

          // Xử lý dữ liệu giảng dạy
          const globalData = await teachingResponse.json();
          console.log('Tổng hợp bảng dữ liệu:', globalData.results);

          // Sau khi có dữ liệu thành công, thực hiện render bảng
          renderTable(globalData.results); // Gọi hàm renderTable sau khi đã có đủ dữ liệu
        };

        // Thêm trình lắng nghe sự kiện cho từng combobox
        document.getElementById('combobox-dot').addEventListener('change', handleComboboxChange);
        document.getElementById('combobox-ki').addEventListener('change', handleComboboxChange);
        document.getElementById('combobox-nam').addEventListener('change', handleComboboxChange);
        document.getElementById('combobox-khoa').addEventListener('change', handleComboboxChange);

        // Gọi updateValues để lấy giá trị mặc định ngay khi tải trang
        updateValues();

        // Tạo đối tượng dữ liệu để gửi ngay khi tải trang
        const requestData = {
          Khoa: khoaValue,
          Dot: dotValue,
          Ki: kiValue,
          Nam: namValue,
        };

        console.log(requestData);
        // Fetch thông tin giảng dạy ngay khi tải trang
        const teachingResponse = await fetch('http://localhost:3000/quy-chuan-chinh-thuc', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestData),
        });

        if (!teachingResponse.ok) {
          alert("Lỗi truy vấn!");
          return;
        }

        // Xử lý dữ liệu giảng dạy ngay khi tải trang
        const globalData = await teachingResponse.json();
        console.log('Tổng hợp bảng dữ liệu:', globalData.results);

        // Sau khi có dữ liệu thành công, thực hiện render bảng
        renderTable(globalData.results); // Gọi hàm renderTable sau khi đã có đủ dữ liệu

      } catch (error) {
        console.error('Đã có lỗi xảy ra:', error);
      }
    }

    // Hàm renderTable sẽ được sử dụng để render bảng
    function renderTable(data) {
      // Chọn các cột bạn muốn hiển thị
      const columnsToDisplay = ['Khoa', 'Dot', 'KiHoc', 'NamHoc', 'GiaoVienGiangDay', 'MoiGiang', 'SoTinChi', 'TenLop', 'LL', 'QuyChuan'];
      let tableHtml = '';

      const headersMap = {
        'Khoa': 'Khoa',
        'Dot': 'Đợt',
        'KiHoc': 'Kì',
        'NamHoc': 'Năm',
        'GiaoVienGiangDay': 'Giảng viên giảng dạy',
        'MoiGiang': 'Mời giảng?',
        'SoTinChi': 'Số tín chỉ',
        'TenLop': 'Tên lớp',
        'LL': 'Số tiết lên lớp',
        'QuyChuan': 'Số tiết quy chuẩn',
      };

      // Tạo header
      columnsToDisplay.forEach(header => {
        const newHeaderName = headersMap[header] || header; // Sử dụng tên cột mới nếu có
        tableHtml += `<th>${newHeaderName}</th>`;
      });

      document.getElementById('table-header').innerHTML = tableHtml;

      // Xóa dữ liệu bảng cũ nếu có trước khi thêm mới
      document.getElementById('data-table-body').innerHTML = '';

      // Duyệt qua từng mục trong dữ liệu
      data.forEach(item => {
        let rowHtml = columnsToDisplay.map(key => {
          let cellValue = item[key] !== null ? item[key] : '';

          // Chuyển đổi 0 và 1 thành 'Có' hoặc 'Không'
          if (key === 'MoiGiang') {
            cellValue = cellValue === 1 ? 'Có' : 'Không';
          }

          return `<td>${cellValue}</td>`;
        }).join('');

        document.getElementById('data-table-body').innerHTML += `<tr>${rowHtml}</tr>`;
      });

      // Xóa spinner sau khi hoàn thành (nếu có spinner)
      const loadingSpinner = document.getElementById('loading-spinner');
      if (loadingSpinner) {
        loadingSpinner.remove();
      }
    }

    // Thêm sự kiện cho nút lọc
    document.getElementById('filter').addEventListener('click', function () {
      const rows = document.querySelectorAll('#data-table-body tr');
      rows.forEach(row => {
        const cells = row.getElementsByTagName('td');
        const moiGiang = cells[2].textContent; // Giả sử "Mời giảng" là cột thứ 3 (index 2)
        if (moiGiang !== 'Có') { // Lọc theo giá trị 'Có' thay vì 1
          row.style.display = 'none'; // Ẩn hàng nếu "Mời giảng" không phải là 'Có'
        } else {
          row.style.display = ''; // Hiện hàng nếu "Mời giảng" là 'Có'
        }
      });
    });


    // Phần phân quyền
    document.addEventListener('DOMContentLoaded', () => {
      const importLink = document.getElementById("Import");

      importLink.addEventListener("click", function (event) {
        event.preventDefault(); // Ngăn chặn hành vi mặc định của liên kết

        const role = localStorage.getItem("userRole"); // Lấy role từ localStorage

        if (role.includes("DAOTAO") || role.includes("TAICHINH")) {
          window.location.href = "/import";
        } else {
          window.location.href = "/importGvmList";
        }
      });

      const ThongTinGD = document.getElementById("ThongTinGD");

      ThongTinGD.addEventListener("click", function (event) {
        event.preventDefault(); // Ngăn chặn hành vi mặc định của liên kết

        const role = localStorage.getItem("userRole");

        if (role.includes("DAOTAO") || role.includes("TAICHINH")) {
          window.location.href = "/info2";
        } else {
          window.location.href = "/info";
        }
      });

      const Home = document.getElementById("Home");

      Home.addEventListener("click", function (event) {
        event.preventDefault(); // Ngăn chặn hành vi mặc định của liên kết

        const role = localStorage.getItem("userRole");

        if (role.includes("DAOTAO") || role.includes("TAICHINH")) {
          window.location.href = "/maindt";
        } else {
          window.location.href = "/mainkhoa";
        }
      });
    });
  </script>

  <!-- Phần phân quyền -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Thêm sự kiện click cho phần tử có id "import"
      const importLink = document.getElementById("Import");

      importLink.addEventListener("click", function (event) {
        event.preventDefault(); // Ngăn chặn hành vi mặc định của liên kết

        const isKhoa = localStorage.getItem("isKhoa"); // Lấy role từ localStorage

        if (isKhoa == 0) { // Nếu là đào tạo hoặc tài chính
          window.location.href = "/import";
        } else { // Nếu là khoa
          window.location.href = "/importGvmList";
        }
      });

      // Thêm sự kiện click cho phần tử có id="ThongTinGD"
      const ThongTinGD = document.getElementById("ThongTinGD");

      ThongTinGD.addEventListener("click", function (event) {
        event.preventDefault(); // Ngăn chặn hành vi mặc định của liên kết

        const isKhoa = localStorage.getItem("isKhoa"); // Lấy role từ localStorage

        if (isKhoa == 0) { // Nếu là đào tạo hoặc tài chính
          window.location.href = "/info2";
        } else {
          window.location.href = "/info";
        }
      });

      // Thêm sự kiện click cho phần tử có id="Home"

      const Home = document.getElementById("Home");

      Home.addEventListener("click", function (event) {
        event.preventDefault(); // Ngăn chặn hành vi mặc định của liên kết

        const isKhoa = localStorage.getItem("isKhoa")

        if (isKhoa == 0) { // Nếu là đào tạo hoặc tài chính
          window.location.href = "/maindt";
        } else {
          window.location.href = "/mainkhoa";
        }
      });
    });

  </script>

  <script>
    window.onload = function () {
      const TenNhanVien = localStorage.getItem("TenNhanVien"); // Lấy tên người dùng từ localStorage
      const Role = localStorage.getItem("userRole");

      if (TenNhanVien) {
        // Hiển thị tên người dùng trên phần tử HTML
        document.querySelector('.fullname').innerText = `${TenNhanVien} - ${Role}`;
      } else {
        document.querySelector('.fullname').innerText = 'Hi, Guest'; // Hiển thị nếu không có tên người dùng
      }

      document.querySelector('.role').innerText = `${Role}`;

    };
  </script>

</body>

</html>